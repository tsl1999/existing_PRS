---
title: "DPhil Meeting"
author: "Tianshu Liu"
date: "2023-05-18"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4


---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```
```{r,include=FALSE}
rm(list=ls())
#set working directory load package-----------------
working_path<-'/well/emberson/users/hma817/projects/existing_PRS'
data_path<-paste(working_path,'/data',sep='')
graphs_path<-paste(working_path,'/graphs',sep='')
setwd(working_path)

library(data.table)
library(ggplot2)
library(ggfortify)
library(tidyr)
library(dplyr)
library(pROC)
library(ROCR)
library(caret)
library(corrplot)
library(DescTools)
library(flextable)
library(survival)
library(survminer)
library(dynpred)
library(Epi)
library(forestploter)
source("/gpfs3/well/emberson/users/hma817/codes/R_TablesFunction_27Sep2022_TL.r")
source("/gpfs3/well/emberson/users/hma817/projects/existing_PRS/0.1.utils.R")
```


## Progress so far

- 7 PRSs computed (5 used PGS ID and 2 used custom score files)
- PRSs are standardised (mean=0 and sd =1)
- Age >75 at baseline, death graded above C removed
- Outcome defined as: baseline CAD+ CAD mortality (any mention on the death certificate EPA001)
- Table 1 baseline characteristics
- Correlation heatmap
- Primary analysis
- Simple analysis (no adjustment)
- Partial analysis (adjusted for age at at baseline, sex and 7 genetic PCs)
- Full adjustment (additionally adjust for smoking status, waist hip ratio, systolic blood pressure, diastolic blood pressure, education level, diabetes at baseline
- Seconary analysis


## Density plots

### Distribution by case/control

![distribution by case](/well/emberson/users/hma817/projects/existing_PRS/graphs/PRS_standardised_byCaseCtrl_EPA_31May2023.png)

### Distribution by sex

![distribution by sex](/well/emberson/users/hma817/projects/existing_PRS/graphs/PRS_standardised_bysex_31May2023.png)

### Age distribution by case/control

![ageby case](/well/emberson/users/hma817/projects/existing_PRS/graphs/Age_at_recruitment_byCaseCtrl_EPA_31May2023.png)

### Age now by case/control

Age now for participants is measured at 2022/05/01  (the mortality data retrieved data?)

![age by case](/well/emberson/users/hma817/projects/existing_PRS/graphs/Age_now_byCaseCtrl_EPA_31May2023.png)

## Correlation heatmap

- PGS000011 Tada et al
- PGS000013 Khera et al
- PGS000018 Inouye et al (metascore)
- PGS001780 Tamlander et al (PGS-CS)
- PGS003446 Tcheandjieu et al (MVP)
- PGS000337 Koyama et al (Japanese trans ethnic)
- Oni-Orisan (Hispanic population) 






![correlation heatmap](/well/emberson/users/hma817/projects/existing_PRS/graphs/correlation_heatmap.png)

## Baseline characteristics

```{r, include=FALSE}
table1<-readRDS(paste(data_path,"/table1_31May2023.rds",sep=""))
```
```{r,echo=FALSE}
flex_baseline<-my_table(table1, y=c(1:3,10,16,22,23,38))
flex_baseline <- add_header_row(flex_baseline, values =  c("Characteristic", "Gender"),
    colwidths = c(1, 3), top = T)
flex_baseline <- compose(flex_baseline, i = 28, j = 1, part = "body",
    value = as_paragraph(
      "\U{00A0}\U{00A0}BMI (kg/m",
      as_sup("2"),")"    ) )
flex_baseline<-add_footer_lines(flex_baseline,"Abbreviation \n SBP:systolic blood pressure, DBP: diastolic blood pressure, BMI: body mass index, NMR:nuclear magnetic resonance, HDL-C: high density lipoprotein cholesterol, LDL-C: low density lipoprotein cholesterol, HbA1c: hemoglobin A1c")
flex_baseline<-footnote(flex_baseline,i=1,j=1,part="header",ref_symbols="*",value = as_paragraph("Table excludes individuals with age over 75, over one year of inconsistent age between death certificate and baseline or missing genetic data."))

#flex_baseline<-footnote(flex_baseline,i=23,j=1,part="body",ref_symbols="$",value = as_paragraph("Among participants with complete measurements, HDL_C and LDL_C have around 23% missingness."))

flex_baseline<-footnote(flex_baseline,i=42,j=1,part="body",ref_symbols="ยง",value = as_paragraph("Other diseases include self-reported emphysema, chronic kidney disease, peptic ulcer,cirrhosis, and peripheral arterial disease."))
fpp <- fp_par(text.align = "left", padding = 3)
flex_baseline<-set_caption(
 flex_baseline,
  caption = "Baseline Characteristics",align_with_table = FALSE,
 word_stylename = "Table Caption",
  fp_p = fpp
)

my_theme(flex_baseline,y=c(1:42))
```

## Quintile tables

### Quintile table (PGS000011)

```{r,include=FALSE}
pgs_quintile<-readRDS(paste(data_path,"/PRS_quintile_tables_31May2023.rds",sep=""))
```

```{r,include=FALSE}
p<-NA
pgsname<-colnames(data)[33:39]
fpp <- fp_par(text.align = "left", padding = 3)
for (i in 1:7){
  flex_pgs<-my_table(pgs_quintile[[i]], y=c(2,3,4,6,8,10,12,14,16,19,22,28,35,41:45),x=1:7)
  flex_pgs <- add_header_row(flex_pgs, values =  c("Characteristic", "Quintiles"," "),
    colwidths = c(1, 5,1), top = T)
  flex_pgs<-add_footer_lines(flex_pgs,"Abbreviation \n SBP:systolic blood pressure, DBP: diastolic blood pressure, BMI: body mass index, NMR:nuclear magnetic resonance, HDL-C: high density lipoprotein cholesterol, LDL-C: low density lipoprotein cholesterol, HbA1c: hemoglobin A1c")
flex_pgs<-footnote(flex_pgs,i=2,j=1,part="header",ref_symbols="*",value = as_paragraph("Table excludes individuals with age over 75, over one year of inconsistent age between death certificate and baseline or missing genetic data."))
flex_pgs<-footnote(flex_pgs,i=45,j=1,part="body",ref_symbols="ยง",value = as_paragraph("Other diseases include self-reported emphysema, chronic kidney disease, peptic ulcer,cirrhosis, and peripheral arterial disease."))
flex_pgs<-footnote(flex_pgs,i=2,j=7,part="header",ref_symbols="$",value = as_paragraph("T-test for continuous traits and Chi Squared test for categorical traits.Round up to 2 decimal places."))
flex_pgs<-set_caption(
 flex_pgs,
  caption = paste(pgsname[i], "table"),align_with_table = FALSE,
 word_stylename = "Table Caption",
  fp_p = fpp
)
flex_pgs<-padding(flex_pgs,padding = 0, part = "all")
flex_pgs<-line_spacing(flex_pgs,space =0.8, part = "all")
p[i]<-list(my_theme(flex_pgs,y=c(1:44),z=1:6,fontsize = 6.8))

}
```

```{r}
p[[1]]
```


### Quintile table (PGS000013) 

```{r,echo=FALSE}
p[[2]]
```

### Quintile table (PGS000018)

```{r,echo=FALSE}
p[[3]]
```

### Quintile table (PGS001780)

```{r,echo=FALSE}
p[[4]]
```

### Quintile table (PGS003446)

```{r,echo=FALSE}
p[[5]]
```

### Quintile table (PGS000337)

```{r,echo=FALSE}
p[[6]]
```

### Quintile table (Oni-Orisan et al)

```{r,echo=FALSE}
p[[7]]

```

## Primary analysis 

### EPO

```{r,echo=FALSE}
EPO_without_PRS<-readRDS(paste(data_path,"/Prevalent_CHD_EPO_withoutPRS.rds",sep=""))
print(EPO_without_PRS)
```

#### continuous PRS


```{r, include=FALSE}
prevalent_EPO_cont<-readRDS(paste(data_path,"/Prevalent_CHD_EPO_cont_logistic_06Jun2023.rds",sep=""))
```


```{r,echo=FALSE}
prev_cont_flextable(prevalent_EPO_cont)

```


#### forest table

![ ](/well/emberson/users/hma817/projects/existing_PRS/graphs/logistic/Logistic_forestplotEPO_cont_.png)



#### PRS in deciles



![ ](/well/emberson/users/hma817/projects/existing_PRS/graphs/logistic/FAR_ggplot_Prevalent_CHD_EPO_Partial.png)

### EPA

```{r,echo=FALSE}
EPA_without_PRS<-readRDS(paste(data_path,"/Prevalent_CHD_EPA_withoutPRS.rds",sep=""))
print(EPA_without_PRS)
```

```{r, include=FALSE}
prevalent_EPA_cont<-readRDS(paste(data_path,"/Prevalent_CHD_EPA_cont_logistic_06Jun2023.rds",sep=""))
```


```{r,echo=FALSE}
prev_cont_flextable(prevalent_EPA_cont)

```

#### forest table

![ ](/well/emberson/users/hma817/projects/existing_PRS/graphs/logistic/Logistic_forestplotEPA_cont.png)

#### PRS in deciles



![ ](/well/emberson/users/hma817/projects/existing_PRS/graphs/logistic/FAR_ggplot_Prevalent_CHD_EPA_Partial.png)


## CAD mortality

### Linearity check martingale residual

1. Waist-to-hip ratio

![](/well/emberson/users/hma817/projects/existing_PRS/graphs/Martingale_residual_WHRATIO.png)

2.Systolic blood pressure

![](/well/emberson/users/hma817/projects/existing_PRS/graphs/Martingale_residual_SBP.png)


3.Diastolic blood pressure

![](/well/emberson/users/hma817/projects/existing_PRS/graphs/Martingale_residual_DBP.png)



### EPO001
#### Forest plot
![ ](/well/emberson/users/hma817/projects/existing_PRS/graphs/cox/cox_forestplotEPO001_cont.png)

```{r,echo=FALSE}
EPO001_cont<-readRDS(paste(data_path,"/EPO001_cont_model_outcomes_05Jun2023.rds",sep=""))
flex_cont<-my_table(EPO001_cont,y=c(1:3,6),x=1:8)
flex_cont<-footnote(flex_cont,i=c(3,6),j=1,part="body",value = as_paragraph(c("Partial adjusted models adjust for Sex and age groups. Fully adjusted models additionally adjust for  waist-to-hip ratio, systolic and diastolic blood pressure, education attainmen level, smoking status,diabetes at baseline")),ref_symbols = c("*"))
flex_cont <- add_header_row(flex_cont, values =  c(" ", "European PRS","Non-European PRS"),
    colwidths = c(1, 4,3), top = T)



my_theme(flex_cont,y=c(1,2,5,8),set_padding = 3,fontsize = 8,header_border = 7)
```
#### PRS in deciles

![ ](/well/emberson/users/hma817/projects/existing_PRS/graphs/cox/FAR_ggplot_EPO001_Partial.png)

### EPA001
#### Forest plot
![ ](/well/emberson/users/hma817/projects/existing_PRS/graphs/cox/cox_forestplotEPA001_cont.png)

```{r,echo=FALSE}
EPO001_cont<-readRDS(paste(data_path,"/EPA001_cont_model_outcomes_05Jun2023.rds",sep=""))
flex_cont<-my_table(EPO001_cont,y=c(1:3,6),x=1:8)
flex_cont<-footnote(flex_cont,i=c(3,6),j=1,part="body",value = as_paragraph(c("Partial adjusted models adjust for Sex and age groups. Fully adjusted models additionally adjust for  waist-to-hip ratio, systolic and diastolic blood pressure, education attainmen level, smoking status,diabetes at baseline")),ref_symbols = c("*"))
flex_cont <- add_header_row(flex_cont, values =  c(" ", "European PRS","Non-European PRS"),
    colwidths = c(1, 4,3), top = T)



my_theme(flex_cont,y=c(1,2,5,8),set_padding = 3,fontsize = 8,header_border = 7)
```

![ ](/well/emberson/users/hma817/projects/existing_PRS/graphs/cox/FAR_ggplot_EPA001_Partial.png)

## Baseline CAD only

```{r,echo=FALSE}
BASE_without_PRS<-readRDS(paste(data_path,"/BASE_CHD_withoutPRS.rds",sep=""))
print(BASE_without_PRS)
```


```{r,echo=FALSE}
prevalent_base_cont<-readRDS(paste(data_path,"/Prevalent_CHD_EPA_cont_logistic_15Jun2023.rds",sep=""))
prev_cont_flextable(prevalent_base_cont)

```

### forest plot
![ ](/well/emberson/users/hma817/projects/existing_PRS/graphs/logistic/Logistic_forestplotbaseCHD_cont.png)

### PRS in deciles

![ ](/well/emberson/users/hma817/projects/existing_PRS/graphs/logistic/FAR_ggplot_BASE_CHD_Partial.png)

## Age over 75 EPA

```{r,echo=FALSE}
CHD_without_PRS75<-readRDS(paste(data_path,"/Prevalent_CHD_EPA_withoutPRS75.rds",sep=""))
print(CHD_without_PRS75)
```


```{r,echo=FALSE}
prevalent_cont_75<-readRDS(paste(data_path,"/Prevalent_CHD_EPA_cont75_logistic_15Jun2023.rds",sep=""))
prev_cont_flextable(prevalent_cont_75)
```
### Forest plot

![ ](/well/emberson/users/hma817/projects/existing_PRS/graphs/logistic/Logistic_forestplotbaseCHD_cont75.png)

### PRS in quintiles

![ ](/well/emberson/users/hma817/projects/existing_PRS/graphs/logistic/FAR_ggplot_Prevalent_CHD_EPA75_Partial.png)


## Stratified for sex

### EPA
#### Female

```{r,echo=FALSE}
model_withoutPRS_EPA_female<-readRDS(paste(data_path,"/Prevalent_CHD_EPA_withoutPRSF.rds",sep=""))
print(model_withoutPRS_EPA_female)
```

 
```{r,echo=FALSE}
prevalent_cont_F<-readRDS(paste(data_path,"/Prevalent_CHD_EPA_contF_logistic_13Jun2023.rds",sep=""))
prev_cont_flextable(prevalent_cont_F)
```
```{r,echo=FALSE}
model_withoutPRS_EPA_male<-readRDS(paste(data_path,"/Prevalent_CHD_EPA_withoutPRSM.rds",sep=""))
print(model_withoutPRS_EPA_male)
```


#### Male 

```{r,echo=FALSE}
prevalent_cont_M<-readRDS(paste(data_path,"/Prevalent_CHD_EPA_contM_logistic_13Jun2023.rds",sep=""))
prev_cont_flextable(prevalent_cont_M)
```


### forest plot
#### Female

![ ](/well/emberson/users/hma817/projects/existing_PRS/graphs/logistic/Logistic_forestplotEPA_contf.png)

#### Male

![ ](/well/emberson/users/hma817/projects/existing_PRS/graphs/logistic/Logistic_forestplotEPA_contm.png)

### PRS decile
 
#### Female

![ ](/well/emberson/users/hma817/projects/existing_PRS/graphs/logistic/FAR_ggplot_Prevalent_CHD_EPA_F_Partial.png)

#### Male

![ ](/well/emberson/users/hma817/projects/existing_PRS/graphs/logistic/FAR_ggplot_Prevalent_CHD_EPA_M_Partial.png)
