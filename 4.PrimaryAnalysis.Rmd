---
title: "4.Primary Analysis"
author: "Tianshu Liu"
date: "2023-04-18"
output: word_document
---
This file is a markdown file for the primary analysis of 7 published PRSs
The ambiguous SNPs are removed. PRS are standardised with mean as 0 and sd as 1.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#call packages and data
##package and self-create function
```{r, include=FALSE}
rm(list=ls())
#set working directory load package-----------------
working_path<-'/well/emberson/users/hma817/projects/existing_PRS'
data_path<-paste(working_path,'/data',sep='')
graphs_path<-paste(working_path,'/graphs',sep='')
setwd(working_path)

library(data.table)
library(ggplot2)
library(tidyr)
library(dplyr)
library(pROC)
library(ROCR)
library(caret)
library(corrplot)
library(DescTools)
library(flextable)
library(forestploter)

source("/gpfs3/well/emberson/users/hma817/codes/R_TablesFunction_27Sep2022_TL.r")
source("/gpfs3/well/emberson/users/hma817/projects/existing_PRS/0.1.utils.R")
```

##data
```{r,include=FALSE}
data<-readRDS(paste(data_path,"FullData_standardisedPRS_29May2023.rds",sep="/"))
data<-data[,c(1:32,35:41)]
table1_data<-readRDS(paste(data_path,"Table1_data_standardisedPRS_07May2023.rds",sep="/"))
colnames(data)[33:39]<-sub("_standardised","",colnames(data)[33:39])#remove standardised after all PRS names to make column names shorter
colnames(data)[39]<-"custom_Oni_Orisan"# change custom_Oni-Orisan to Oni_Orisan so that formula() can read it

variants_included<-readRDS(paste(data_path,"variants_included.rds",sep="/"))
  variant_t<-data.frame(t(variants_included))
  colnames(variant_t)<-variant_t[1,]
  variant_t<-variant_t[2,]
  variant_t<-cbind(rownames(variant_t),variant_t)
  colnames(variant_t)[1]<-NA
  colnames(variant_t)[8]<-"custom_Oni_Orisan"
  variant_t[1,1]<-"Number of SNPs"


variant_t[2:8]<-prettyNum(variant_t[2:8], big.mark = ",", scientific = FALSE)
  
```

#Analysis


```{r,include=FALSE}

PCs<-c(paste0("PC",1:7))
for (i in 1:7){
  quintile<-ntile(data[,32+i],5)
  quintile_low_med_high<-ifelse(quintile<=1,"low",ifelse(
    quintile>1&quintile<5,"intermediate",ifelse(
      quintile>=5,"high",NA
    )
  ))
  quintile_low_med_high<-factor(quintile_low_med_high,levels = c("low","intermediate","high"))
  data[,39+i]<-quintile_low_med_high
  colnames(data)[39+i]<-paste(colnames(data)[32+i],"cat",sep="_")
}

#saveRDS(data,paste(data_path,"/analysis_data_16May2023.rds",sep=""))



```



## primary analysis 
### modelling check without PRS

```{r, echo=FALSE}
cor(data$BMI,data$WHRATIO,method="pearson",use="complete.obs")#
model_without_PRS<-glm(prevalent_CHD_EPA~SEX+AGE+PC1+PC2+PC3+PC4+PC5+PC6+PC7,data=data,family=binomial(link='logit'))
summary(model_without_PRS)
model_without_PRS<-glm(prevalent_CHD_EPA~SEX+AGE+WHRATIO+SBP+DBP+EDU_LEVEL+smokegp+diabetes_at_baseline+PC1+PC2+PC3+PC4+PC5+PC6+PC7,data=data,family=binomial(link='logit'))
summary(model_without_PRS)
```


###  EPA
####without prs 
```{r, include=FALSE}
full_adjustments = c("WHRATIO","SBP","DBP","EDU_LEVEL","smokegp","diabetes_at_baseline")
#prs_table_EPA<-output_table_summary(outcome="prevalent_CHD_EPA",data=data,full_adjustments,trainsplit=F,train_data=NULL,test_data=NULL)

```
```{r,echo=FALSE}
model_withoutPRS_EPA<-discrimination_without_prs(train_data = data,test_data = data,full_adjustments = full_adjustments,outcome="prevalent_CHD_EPA")
print(model_withoutPRS_EPA)
#saveRDS(model_withoutPRS_EPA,paste(data_path,"/Prevalent_CHD_EPA_withoutPRS.rds",sep=""))
```



```{r,include=FALSE}

prs_table_EPA<-output_table_summary(outcome="prevalent_CHD_EPA",data=data,full_adjustments,trainsplit=F)

```
![simple model with continuous PRS](/well/emberson/users/hma817/projects/existing_PRS/graphs/AUCplot_simple_prevalent_CHD_EPA_cont.jpg)
![Partial model with continuous PRS](/well/emberson/users/hma817/projects/existing_PRS/graphs/AUCplot_partial_prevalent_CHD_EPA_cont.jpg)
![Full model with continuous PRS](/well/emberson/users/hma817/projects/existing_PRS/graphs/AUCplot_full_prevalent_CHD_EPA_cont.jpg)

![simple model with categorical PRS](/well/emberson/users/hma817/projects/existing_PRS/graphs/AUCplot_simple_prevalent_CHD_EPA_cat.jpg)
![partial model with categorical PRS](/well/emberson/users/hma817/projects/existing_PRS/graphs/AUCplot_partial_prevalent_CHD_EPA_cat.jpg)
![full model with categorical PRS](/well/emberson/users/hma817/projects/existing_PRS/graphs/AUCplot_full_prevalent_CHD_EPA_cat.jpg)




```{r,include=FALSE}
#saveRDS(prs_table_EPA,paste(data_path,"/Prevalent_CHD_EPA_model_outcomes_09May_2023.rds",sep=""))
prs_table_EPA_cont<-prs_table_EPA[[1]]
prs_table_EPA_cat<-prs_table_EPA[[2]]
```


```{r, echo=FALSE}
flex_cont<-my_table(prs_table_EPA_cont,y=c(1,2,7,12),x=1:8)
flex_cont<-footnote(flex_cont,i=c(2,7,12),j=1,part="body",value = as_paragraph(c("No adjustments","Adjust for Age at baseline, Sex and 7 genetic PCs","Partial model adjustments + waist-to-hip ratio, systolic and diastolic blood pressure, education attainmen level, smoking status,diabetes at baseline")),ref_symbols = c("*","$","ยง"))
my_theme(flex_cont,y=c(1,6,11,16),z=1:8)
```
```{r}
flex_cat<-my_table(prs_table_EPA_cat,y=c(1,2,8,14),x=1:8)
flex_cat<-footnote(flex_cat,i=1,j=2:8,part="header",value = as_paragraph(c("PRSs are divided in to 5 quintiles, Low PRS=Q1, Intermediate PRS=Q2-4, High PRS=Q5")),ref_symbols = c("+"))
flex_cat<-footnote(flex_cat,i=c(2,8,14),j=1,part="body",value = as_paragraph(c("No adjustments","Adjust for Age at baseline, Sex and 7 genetic PCs","Partial model adjustments + waist-to-hip ratio, systolic and diastolic blood pressure, education attainmen level, smoking status,diabetes at baseline")),ref_symbols = c("*","$","ยง"))

my_theme(flex_cat,y=c(1,7,13,19),z=1:8)
```



### EPO

###without prs 
```{r,echo=FALSE}
model_withoutPRS_EPO<-discrimination_without_prs(train_data = data,test_data = data,full_adjustments = full_adjustments,outcome="prevalent_CHD_EPO")
#saveRDS(model_withoutPRS_EPO,paste(data_path,"/Prevalent_CHD_EPO_withoutPRS.rds",sep=""))
print(model_withoutPRS_EPO)
```


```{r,include=FALSE}
prs_table_EPO<-output_table_summary(outcome="prevalent_CHD_EPO",data=data,full_adjustments,trainsplit=F)
#saveRDS(prs_table_EPO,paste(data_path,"/Prevalent_CHD_EPO_model_outcomes_09May2023.rds",sep=""))
```

```{r}
prs_table_EPO_cont<-prs_table_EPO[[1]]
prs_table_EPO_cat<-prs_table_EPO[[2]]
```

```{r,echo=FALSE}
flex_cont<-my_table(prs_table_EPO_cont,y=c(1,2,7,12),x=1:8)
flex_cont<-footnote(flex_cont,i=c(2,7,12),j=1,part="body",value = as_paragraph(c("No adjustments","Adjust for Age at baseline, Sex and 7 genetic PCs","Partial model adjustments + waist-to-hip ratio, systolic and diastolic blood pressure, education attainmen level, smoking status,diabetes at baseline")),ref_symbols = c("*","$","ยง"))
my_theme(flex_cont,y=c(1,6,11,16),z=1:8)
```

```{r}
flex_cat<-my_table(prs_table_EPO_cat,y=c(1,2,8,14),x=1:8)
flex_cat<-footnote(flex_cat,i=1,j=2:8,part="header",value = as_paragraph(c("PRSs are divided in to 5 quintiles, Low PRS=Q1, Intermediate PRS=Q2-4, High PRS=Q5")),ref_symbols = c("+"))
flex_cat<-footnote(flex_cat,i=c(2,8,14),j=1,part="body",value = as_paragraph(c("No adjustments","Adjust for Age at baseline, Sex and 7 genetic PCs","Partial model adjustments + waist-to-hip ratio, systolic and diastolic blood pressure, education attainmen level, smoking status,diabetes at baseline")),ref_symbols = c("*","$","ยง"))

my_theme(flex_cat,y=c(1,7,13,19),z=1:8)
```




