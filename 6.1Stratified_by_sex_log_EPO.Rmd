---
title: "5.2 Stratified by sex"
author: "Tianshu Liu"
date: "2023-05-17"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,include=FALSE}
rm(list=ls())
#set working directory load package-----------------
working_path<-'/well/emberson/users/hma817/projects/existing_PRS'
data_path<-paste(working_path,'/data',sep='')
graphs_path<-paste(working_path,'/graphs',sep='')
setwd(working_path)


library(data.table)
library(ggplot2)
library(tidyr)
library(dplyr)
library(pROC)
library(ROCR)
library(caret)
library(corrplot)
library(DescTools)
library(flextable)
library(forestploter)
library(grid)
library(Epi)
```

```{r,include=FALSE}
data<-readRDS(paste(data_path,"analysis_data_13Jun2023.rds",sep="/"))
data_decile<-readRDS(paste(data_path,"/analysis_data_31May2023.rds",sep=""))
data_d<-data_decile[,c(1:32,40:46)]
model_table_top<-readRDS(paste(data_path,"/model_table_top.rds",sep=""))

source("/gpfs3/well/emberson/users/hma817/codes/R_TablesFunction_27Sep2022_TL.r")
source("/gpfs3/well/emberson/users/hma817/projects/existing_PRS/0.1.utils.R")  
```

#stratified by sex EPO
```{r,include=FALSE}
data_female<-data[data$SEX=="Women",]
data_male<-data[data$SEX=="Men",]
data_female_d<-data_d[data_d$SEX=="Women",]
data_female_up<-data_decile[data_decile$SEX=="Women",]
data_male_d<-data_d[data_d$SEX=="Men",]
data_male_up<-data_decile[data_decile$SEX=="Men",]
```


```{r,echo=FALSE}
table(data$prevalent_CHD_EPO)
table(data$SEX)
prop.table(table(data_female$prevalent_CHD_EPO))
prop.table(table(data_male$prevalent_CHD_EPO))
prop.table(table(data_female_d$prevalent_CHD_EPO))
prop.table(table(data_male_d$prevalent_CHD_EPO))
```
```{r,include=FALSE}
non_adjustment=NULL
partial_adjustments=c("AGE")
full_adjustments = c("AGE","WHRATIO","SBP","DBP","EDU_LEVEL","smokegp","diabetes_at_baseline")
```

##Female
```{r}
model_withoutPRS_EPO_female<-discrimination_without_prs(train_data = data_female,test_data = data_female,full_adjustments = full_adjustments,outcome="prevalent_CHD_EPO",partial_adjustment = partial_adjustments)
print(model_withoutPRS_EPO_female)
#saveRDS(model_withoutPRS_EPO_female,paste(data_path,"/Prevalent_CHD_EPO_withoutPRSF.rds",sep=""))
```

```{r,include=FALSE}
model_output_partialf<-create_output_table(trainsplit = F,data_female,adjustments=partial_adjustments,outcome="prevalent_CHD_EPO",namew="partialF")

model_output_fullf<-create_output_table(trainsplit = F,data_female,adjustments=full_adjustments,outcome="prevalent_CHD_EPO",namew="fullF")
```


```{r,include=FALSE}
prevalent_EPO_contf<-combine_model_tables(tables=list(model_output_partialf,model_output_fullf),name = c("Partially adjusted","Fully adjusted"),log_cox = "log")
#saveRDS(prevalent_EPO_contf,paste(data_path,"/Prevalent_CHD_EPO_contF_logistic_13Jun2023.rds",sep=""))
```
```{r,echo=FALSE}
flex_cont<-my_table(prevalent_EPO_contf,y=c(1:3,8),x=1:8)
flex_cont<-footnote(flex_cont,i=c(3,8),j=1,part="body",value = as_paragraph(c("Partially adjusted models adjust for Sex and baseline age. Fully adjusted models additionally adjust for waist-to-hip ratio, systolic and diastolic blood pressure, education attainmen level, smoking status,diabetes at baseline")),ref_symbols = c("*"))

flex_cont<-add_footer_lines(flex_cont,value = as_paragraph(c("The table is ordered by PRSs target ethnicity and publication date")))
flex_cont <- add_header_row(flex_cont, values =  c(" ", "European PRS","Non-European PRS"),
    colwidths = c(1, 4,3), top = T)

flex_cont <- compose(flex_cont, i = c(6,11), j = 1, part = "body",
    value = as_paragraph(
      "\U{00A0}\U{00A0}Naglekerke pseudo R",
      as_sup("2")   ) )

flex_cont <- compose(flex_cont, i = c(7,12), j = 1, part = "body",
    value = as_paragraph(
      "\U{00A0}\U{00A0}Lee's pseudo R",
      as_sup("2")   ) )


my_theme(flex_cont,y=c(1,2,7),set_padding = 3,fontsize = 8,header_border = 7)
```


```{r,include=FALSE}
forest_table<-generate_forest_table(tables=list(model_output_partialf,model_output_fullf),model_name = c("Partially adjusted","Fully adjusted"),or_hr = "OR",show_pgsname = T)

```


```{r,include=FALSE}
p<-plot_forest(forest_table = forest_table,xlim=c(0.9,1.3),ticks_at = c(0.9,1,1.1,1.2,1.3),hr_or = "OR")
a<-get_wh(p,unit = "cm")

png(paste(graphs_path,"/logistic/Logistic_forestplotEPO_contf",".png",sep=""), res = 200, width = a[1], height = a[2], units = "cm")
print(p)
dev.off()
```


```{r,echo=FALSE}
knitr::include_graphics(paste(graphs_path,"/logistic/Logistic_forestplotEPO_contf",".png",sep=""))
```
### decile plots

```{r,include=FALSE}
model_output_partial<-create_output_table(trainsplit = F,data_female_d,adjustments=partial_adjustments,outcome="prevalent_CHD_EPO",namew="partialF",type = "cat")

model_output_full<-create_output_table(trainsplit = F,data_female_d,adjustments=full_adjustments,outcome="prevalent_CHD_EPO",namew="fullF",type = "cat")
```


```{r}
model_output_list<-list(model_output_partial,model_output_full)

plot_FAR_gg(model_output_list,name=c("Partial","Full"),outcome="Prevalent_CHD_EPO_F",data=data_female_up)
```


##male
```{r,echo=FALSE}
model_withoutPRS_EPO_male<-discrimination_without_prs(train_data = data_male,test_data = data_male,full_adjustments = full_adjustments,outcome="prevalent_CHD_EPO",partial_adjustment = c("AGE"))
print(model_withoutPRS_EPO_male)
#saveRDS(model_withoutPRS_EPO_male,paste(data_path,"/Prevalent_CHD_EPO_withoutPRSM.rds",sep=""))
```
```{r,include=FALSE}
model_output_partialm<-create_output_table(trainsplit = F,data_male,adjustments=partial_adjustments,outcome="prevalent_CHD_EPO",namew="partialM")

model_output_fullm<-create_output_table(trainsplit = F,data_male,adjustments=full_adjustments,outcome="prevalent_CHD_EPO",namew="fullM")
```

```{r,include=FALSE}
prevalent_EPO_contM<-combine_model_tables(tables=list(model_output_partialm,model_output_fullm),name = c("Partially adjusted","Fully adjusted"),log_cox = "log")
#saveRDS(prevalent_EPO_contM,paste(data_path,"/Prevalent_CHD_EPO_contM_logistic_13Jun2023.rds",sep=""))
```



```{r,echo=FALSE}
flex_cont<-my_table(prevalent_EPO_contM,y=c(1:3,8),x=1:8)
flex_cont<-footnote(flex_cont,i=c(3,8),j=1,part="body",value = as_paragraph(c("Partially adjusted models adjust for Sex and baseline age. Fully adjusted models additionally adjust for waist-to-hip ratio, systolic and diastolic blood pressure, education attainmen level, smoking status,diabetes at baseline")),ref_symbols = c("*"))

flex_cont<-add_footer_lines(flex_cont,value = as_paragraph(c("The table is ordered by PRSs target ethnicity and publication date")))
flex_cont <- add_header_row(flex_cont, values =  c(" ", "European PRS","Non-European PRS"),
    colwidths = c(1, 4,3), top = T)

flex_cont <- compose(flex_cont, i = c(6,11), j = 1, part = "body",
    value = as_paragraph(
      "\U{00A0}\U{00A0}Naglekerke pseudo R",
      as_sup("2")   ) )

flex_cont <- compose(flex_cont, i = c(7,12), j = 1, part = "body",
    value = as_paragraph(
      "\U{00A0}\U{00A0}Lee's pseudo R",
      as_sup("2")   ) )


my_theme(flex_cont,y=c(1,2,7),set_padding = 3,fontsize = 8,header_border = 7)
```

```{r,include=FALSE}
forest_table<-generate_forest_table(tables=list(model_output_partialm,model_output_fullm),model_name = c("Partially adjusted","Fully adjusted"),or_hr = "OR",show_pgsname = T)

```


```{r,include=FALSE}
p<-plot_forest(forest_table = forest_table,xlim=c(0.9,1.4),ticks_at = c(0.9,1,1.1,1.2,1.3,1.4),hr_or = "OR")
a<-get_wh(p,unit = "cm")

png(paste(graphs_path,"/logistic/Logistic_forestplotEPO_contm",".png",sep=""), res = 200, width = a[1], height = a[2], units = "cm")
print(p)
dev.off()
```

```{r}
knitr::include_graphics(paste(graphs_path,"/logistic/Logistic_forestplotEPO_contm",".png",sep=""))
```



### decile plots

```{r,include=FALSE}
model_output_partial<-create_output_table(trainsplit = F,data_male_d,adjustments=partial_adjustments,outcome="prevalent_CHD_EPO",namew="partialF",type = "cat")

model_output_full<-create_output_table(trainsplit = F,data_male_d,adjustments=full_adjustments,outcome="prevalent_CHD_EPO",namew="fullF",type = "cat")
```


```{r}
model_output_list<-list(model_output_partial,model_output_full)

plot_FAR_gg(model_output_list,name=c("Partial","Full"),outcome="Prevalent_CHD_EPO_M",data=data_male_up)
```
