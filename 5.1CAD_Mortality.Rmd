---
title: "5.1 Secondary Analysis (CAD mortality)"
author: "Tianshu Liu"
date: "2023-05-11"
output: word_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

#call packages and data
##package and self-create function
```{r, include=FALSE}
rm(list=ls())
#set working directory load package-----------------
working_path<-'/well/emberson/users/hma817/projects/existing_PRS'
data_path<-paste(working_path,'/data',sep='')
graphs_path<-paste(working_path,'/graphs',sep='')
setwd(working_path)

library(data.table)
library(ggplot2)
library(ggfortify)
library(tidyr)
library(dplyr)
library(pROC)
library(ROCR)
library(caret)
library(corrplot)
library(DescTools)
library(flextable)
library(survival)
library(survminer)
library(dynpred)
library(Epi)
library(forestploter)

```

##data
```{r,include=FALSE}
data<-readRDS(paste(data_path,"FullData_timesplit_31May2023.rds",sep="/"))
data<-data[,-c(45:51)]
data2<-readRDS(paste(data_path,"FullData_standardisedPRS_mortality_31May2023.rds",sep="/"))


model_table_top<-readRDS(paste(data_path,"/model_table_top.rds",sep=""))
 data$agegroup<-factor(data$agegroup,levels = c(1:5))
 source("/gpfs3/well/emberson/users/hma817/codes/R_TablesFunction_27Sep2022_TL.r")
source("/gpfs3/well/emberson/users/hma817/projects/existing_PRS/0.1.utils.R")
```





```{r,include=FALSE}
#check km plot of normal data and lexis expansion data
autoplot(survfit(Surv(time=time_in,time2 = time_out,EPO001_up_75)~1,data=data),data=data,risk.table = T)
autoplot(survfit(Surv(followup,data2$EPO001_up&data2$AGE_followup<75)~1,data=data2),data=data2,risk.table = T)
```






```{r,echo=FALSE}
#check events in two data are matched up
table(data$EPA001_up_75)
table(data$EPO001_up_75)
table(data2$EPA001_up&data2$AGE_followup<75)
table(data2$EPO001_up&data2$AGE_followup<75)
```
```{r,echo=FALSE}
#check outputs of two datasets are the same if don't account for time-dependent variables
fit<-coxph(Surv(time_in,time_out,EPO001_up_75,type = "counting")~SEX,data=data)
summary(fit)


fit2<-coxph(Surv(followup,data2$EPO001_up&data2$AGE_followup<75)~SEX,data=data2)
summary(fit2)
```


```{r,include=FALSE}
#mort_fit1<-survfit(Surv(time_in,time_out,EPO001_up_75)~diabetes_at_baseline, data)
#mort_fit2<-survfit(Surv(time_in,time_out,EPO001_up_75)~SEX, data)
#mort_fit3<-survfit(Surv(time_in,time_out,EPO001_up_75)~EDU_LEVEL, data)
#mort_fit4<-survfit(Surv(time_in,time_out,EPO001_up_75)~smokegp,data)


```
```{r,echo=FALSE}

#ggsurvplot(mort_fit1, data = final_data,risk.table = T,pval = T)
#ggsurvplot(mort_fit2, data = final_data,risk.table = T,pval = T)
#ggsurvplot(mort_fit3, data = final_data,risk.table = T,pval = T)
#ggsurvplot(mort_fit4, data = final_data,risk.table = T,pval = T)

#covariate<-c("Baseline diabetes","Gender","Education level","Smoking status")
#fit_list<-list(mort_fit1,mort_fit2,mort_fit3,mort_fit4)
#for (i in 1:4){
  
#  p<-ggsurvplot(fit_list[[i]], data = data,risk.table = T)
  #jpeg(paste(graphs_path,"/KM_plot_",covariate[i],".jpg",sep=""),width = 1000,height = 800)
#  print(p)
  
 #dev.off()
#}
```

##premature deaths------

#adjust for age-bands

```{r,include=FALSE}
model_no_prs_partial<-coxph(Surv(time_in,time_out,EPO001_up_75,type = "counting")~SEX+as.factor(agegroup),data=data)
 c_index_partial<-round(ci_manual(x=concordance(model_no_prs_partial)$concordance,se=sqrt(concordance(model_no_prs_partial)$var)),3)
model_no_prs_full<-coxph(Surv(time_in,time_out,EPO001_up_75,type = "counting")~SEX+as.factor(agegroup)+EDU_LEVEL+as.factor(diabetes_at_baseline)+smokegp+ SBP + 
    DBP + WHRATIO,data=data)
 c_index_full<-round(ci_manual(x=concordance(model_no_prs_full)$concordance,se=sqrt(concordance(model_no_prs_full)$var)),3)


```


```{r,echo=FALSE}

model_withoutPRS_EPO001<-data.frame(partial_cindex=paste(c_index_partial[1],"(",c_index_partial[2],"-",c_index_partial[3],")"),full_cindex=paste(c_index_full[1],"(",c_index_full[2],"-",c_index_full[3],")"))
print(model_withoutPRS_EPO001)
#saveRDS(model_withoutPRS_EPO001,paste(data_path,"/EPO001_withoutPRS.rds",sep=""))
```



```{r,echo=FALSE}
#summary(model_no_prs)
cox.zph(model_no_prs_partial)
cox.zph(model_no_prs_full)

```


### CAD mortality as EPO001

```{r,include=FALSE}
numeric_variable<-c("SBP","DBP","WHRATIO")

for(i in 1:length(numeric_variable)){
  plot_martingale(numeric_variable[i],outcome="EPO001_up_75")
}

for (i in 1:7){
 plot_martingale(colnames(model_table_top)[i+1],outcome="EPO001_up_75",include = "linear",save=paste("/cox/",colnames(model_table_top)[i+1],sep=""))
}
```



```{r,include=FALSE}
outcome="EPO001_up_75"
partial_adjustments=c("SEX","agegroup")
full_adjustments = c(partial_adjustments,c("WHRATIO","SBP","DBP","EDU_LEVEL","smokegp","diabetes_at_baseline"))
```

```{r,include=FALSE}
model_output_partial<-create_output_table_cox(data=data,adjustments=partial_adjustments,outcome=outcome,trainsplit = F)

model_output_full<-create_output_table_cox(data=data,adjustments=full_adjustments,outcome=outcome,trainsplit = F,namew = "_full")
```

```{r,include=FALSE}

EPO001_cont<-combine_model_tables(tables=list(model_output_partial,model_output_full),name = c("Partially adjusted","Fully adjusted"),log_cox = "cox")


#saveRDS(EPO001_cont,paste(data_path,"/EPO001_cont_model_outcomes_05Jun2023.rds",sep=""))
```

### HR table

```{r,echo=TRUE}
flex_cont<-my_table(EPO001_cont,y=c(1:3,6),x=1:8)
flex_cont<-footnote(flex_cont,i=c(3,6),j=1,part="body",value = as_paragraph(c("Partial adjusted models adjust for Sex and age groups. Fully adjusted models additionally adjust for  waist-to-hip ratio, systolic and diastolic blood pressure, education attainmen level, smoking status,diabetes at baseline")),ref_symbols = c("*"))
flex_cont <- add_header_row(flex_cont, values =  c(" ", "European PRS","Non-European PRS"),
    colwidths = c(1, 4,3), top = T)



my_theme(flex_cont,y=c(1,2,5,8),set_padding = 3,fontsize = 8,header_border = 7)
```

##plot forest plot
```{r,include=FALSE}
forest_table<-forest_table_EPO<-generate_forest_table(tables=list(model_output_partial,model_output_full),model_name = c("Partially adjusted","Fully adjusted"),or_hr = "HR",show_pgsname=T)
p<-plot_forest(forest_table = forest_table,xlim=c(0.9,1.35),ticks_at = c(0.9,1,1.1,1.2,1.3),hr_or = "HR")
a<-get_wh(p,unit = "cm")
png(paste(graphs_path,"/cox/cox_forestplotEPO001_cont",".png",sep=""), res = 200, width = a[1], height = a[2], units = "cm")
print(p)
dev.off()
```



```{r}

knitr::include_graphics(paste(graphs_path,"/cox/cox_forestplotEPO001_cont",".png",sep=""))

```
## EPA001
```{r,include=FALSE}
outcome="EPA001_up_75"
partial_adjustments=c("SEX","agegroup")
full_adjustments = c(partial_adjustments,c("WHRATIO","SBP","DBP","EDU_LEVEL","smokegp","diabetes_at_baseline"))

```
```{r,include=FALSE}
model_output_partial<-create_output_table_cox(data=data,adjustments=partial_adjustments,outcome=outcome,trainsplit = F)

model_output_full<-create_output_table_cox(data=data,adjustments=full_adjustments,outcome=outcome,trainsplit = F,namew = "_full")
```


```{r,echo=FALSE}
EPA001_cont<-combine_model_tables(tables=list(model_output_partial,model_output_full),name = c("Partially adjusted","Fully adjusted"),log_cox = "cox")

saveRDS(EPA001_cont,paste(data_path,"/EPA001_cont_model_outcomes_05Jun2023.rds",sep=""))

flex_cont<-my_table(EPO001_cont,y=c(1:3,6),x=1:8)
flex_cont<-footnote(flex_cont,i=c(3,6),j=1,part="body",value = as_paragraph(c("Partial adjusted models adjust for Sex and age groups. Fully adjusted models additionally adjust for  waist-to-hip ratio, systolic and diastolic blood pressure, education attainmen level, smoking status,diabetes at baseline")),ref_symbols = c("*"))
flex_cont <- add_header_row(flex_cont, values =  c(" ", "European PRS","Non-European PRS"),
    colwidths = c(1, 4,3), top = T)



my_theme(flex_cont,y=c(1,2,5),set_padding = 3,fontsize = 8,header_border = 7)

```
```{r,include=FALSE}
forest_table<-forest_table_EPO<-generate_forest_table(tables=list(model_output_partial,model_output_full),model_name = c("Partially adjusted","Fully adjusted"),or_hr = "HR",show_pgsname = T)
p<-plot_forest(forest_table = forest_table,xlim=c(0.9,1.35),ticks_at = c(0.9,1,1.1,1.2,1.3),hr_or = "HR")
a<-get_wh(p,unit = "cm")
png(paste(graphs_path,"/cox/cox_forestplotEPA001_cont",".png",sep=""), res = 200, width = a[1], height = a[2], units = "cm")
print(p)
dev.off()
```

```{r}
knitr::include_graphics(paste(graphs_path,"/cox/cox_forestplotEPA001_cont",".png",sep=""))
```


