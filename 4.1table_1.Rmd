---
title: "4.1 Table 1"
author: "Tianshu Liu"
date: "2023-05-23"
output:
  officedown::rdocx_document:
    reference_docx: /well/emberson/users/hma817/projects/existing_PRS/margin_template.docx


---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```


```{r,include=FALSE}
rm(list=ls())
#set working directory load package-----------------
working_path<-'/well/emberson/users/hma817/projects/existing_PRS'
data_path<-paste(working_path,'/data',sep='')
graphs_path<-paste(working_path,'/graphs',sep='')
setwd(working_path)

library(data.table)
library(ggplot2)
library(tidyr)
library(dplyr)
library(pROC)
library(ROCR)
library(caret)
library(corrplot)
library(DescTools)
library(flextable)

source("/gpfs3/well/emberson/users/hma817/codes/R_TablesFunction_27Sep2022_TL.r")
source("/gpfs3/well/emberson/users/hma817/projects/existing_PRS/0.1.utils.R")
```

##data
```{r,include=FALSE}
data<-readRDS(paste(data_path,"FullData_standardisedPRS_03May2023.rds",sep="/"))
table1_data<-readRDS(paste(data_path,"Table1_data_standardisedPRS_07May2023.rds",sep="/"))
colnames(data)[33:39]<-sub("_standardised","",colnames(data)[33:39])#remove standardised after all PRS names to make column names shorter
colnames(data)[39]<-"custom_Oni_Orisan"# change custom_Oni-Orisan to Oni_Orisan so that formula() can read it

variants_included<-readRDS(paste(data_path,"variants_included.rds",sep="/"))
  variant_t<-data.frame(t(variants_included))
  colnames(variant_t)<-variant_t[1,]
  variant_t<-variant_t[2,]
  variant_t<-cbind(rownames(variant_t),variant_t)
  colnames(variant_t)[1]<-NA
  colnames(variant_t)[8]<-"custom_Oni_Orisan"
  variant_t[1,1]<-"Number of SNPs"


variant_t[2:8]<-prettyNum(variant_t[2:8], big.mark = ",", scientific = FALSE)
  
```

#Analysis
## pairwise correlation check
```{r,include=FALSE}
prs_cor<-cor(data[,33:39],method = "pearson")
jpeg(paste(graphs_path,"/correlation_heatmap",".jpg",sep=""),width = 800, height = 600)
corrplot(prs_cor, type = "lower", order = "original",method="number", 
         tl.col = "black", tl.srt = 45)
dev.off()
prs_cor<-data.frame(prs_cor)

prs_cor$name<-rownames(prs_cor)
prs_cor<-prs_cor[,c(8,1:7)]

```


```{r foo, fig.cap="Correlation heatmap"}
knitr::include_graphics("/well/emberson/users/hma817/projects/existing_PRS/graphs/correlation_heatmap.jpg")
```

## summary stats
```{r, include==FALSE}
table(data$SEX,exclude = NULL)#1=male #2=female
table(data$smokegp,exclude = NULL)
table(data$prevalent_CHD_EPA,exclude = NULL)#6087 prevalent cases
table(data$prevalent_CHD_EPO,exclude = NULL)#5445
data$diabetes_at_baseline<-factor(data$diabetes_at_baseline,levels = c(0,1))
```

\newpage
## Baseline characteristics

```{r,include=FALSE}
table1_data$SEX<-factor(table1_data$SEX,levels = c("Male","Female"),labels = c("Men","Women"))
table1_data$BASE_CHD<-factor(table1_data$BASE_CHD,levels = c(0,1),labels = c("No","Yes"))
table1_data$BASE_CVD<-factor(table1_data$BASE_CVD,levels = c(0,1),labels = c("No","Yes"))
table1_data$BASE_CANCER<-factor(table1_data$BASE_CANCER,levels = c(0,1),labels = c("No","Yes"))
table1_data$BASE_EMPHYSEMA<-factor(table1_data$BASE_EMPHYSEMA,levels = c(0,1),labels = c("No","Yes"))
table1_data$BASE_CIRR<-factor(table1_data$BASE_CIRR,levels = c(0,1),labels = c("No","Yes"))
table1_data$BASE_PEP<-factor(table1_data$BASE_PEP,levels = c(0,1),labels = c("No","Yes"))
table1_data$BASE_CKD<-factor(table1_data$BASE_CKD,levels = c(0,1),labels = c("No","Yes"))
table1_data$BASE_PAD<-factor(table1_data$BASE_PAD,levels = c(0,1),labels = c("No","Yes"))
table1_data$BASE_DIABETES<-factor(table1_data$BASE_DIABETES,levels = c(0,1),labels = c("No","Yes"))
table1_data$base_other<-ifelse(table1_data$BASE_EMPHYSEMA=="Yes"|table1_data$BASE_CIRR=="Yes"|table1_data$BASE_PEP=="Yes"|table1_data$BASE_PAD=="Yes"|table1_data$BASE_CKD=="Yes","Yes","No")
table1_data$base_other<-factor(table1_data$base_other,levels = c("No","Yes"))
table1_data$COYOACAN<-factor(table1_data$COYOACAN,levels = c(0,1),labels = c("No","Yes"))
table1_data$diabetes_at_baseline<-factor(table1_data$diabetes_at_baseline,levels = c(0,1),labels = c("No","Yes"))
table1_data$smokegp<-factor(table1_data$smokegp,levels = c(1:5),labels = c("Never","Ex-smoker","Current (<5/day)","Current (5-14/day)","Current (>14/day)"))
table1_data$EDU_LEVEL<-factor(table1_data$EDU_LEVEL,levels = c(1:4),c("Uni/College","High school","Elementary","Other"),labels = c("University or College","High school","Elementary","Other"))
table1_data$ACTIVITY<-factor(table1_data$ACTIVITY,levels = c("NONE","< ONCE A WEEK","1-2 TIMES A WEEK","AT LEAST 3 TIMES A WEEK"),labels = c("None","< Once a week","1-2 times a week","At least 3 times a week"))
```


```{r,include=FALSE}

variables_to_select<-c("AGE","INCOME","SBP","DBP","BMI","WHRATIO","HDL_C","LDL_C","BASE_HBA1C","smokegp","EDU_LEVEL","ACTIVITY","COYOACAN","BASE_CHD","BASE_CVD","BASE_CANCER","diabetes_at_baseline","base_other")

var_name<-c("Age,years","Individual income(pesos/week)","SBP(mmHg)","DBP(mmHg)","BMI(kg/m2)","Waist to Hip Ratio","NMR measured HDL-C (nm)","NMR measured LDL-C(nm)","Glycated HbA1c (%)","Smoking status","Education level","Leisure-time physical activity","District (Coyoacan)","Self-reported Coronary Artery Disease","Self-reported Cardiovascular Disease","Self-reported Cancer","Diabetes","Other diseases")

baseline<-create_table_1(data=table1_data,variables_to_select = variables_to_select,var_name = var_name,by="SEX")
baseline_hidemissing<-create_table_1(data=table1_data,variables_to_select = variables_to_select,var_name = var_name,by="SEX",missing = F)
baseline_up<-rbind(baseline[c(2,3,19:38),],c("Biological Measures, Mean(SD)",rep(NA,3)),baseline[c(4:17),],c("Reoprted medical history, N(%)",rep(NA,3)),baseline[c(39:43),])
rownames(baseline_up)<-seq(1:nrow(baseline_up))
for (i in c(24:37,39:43)){
  baseline_up[i,1]<-paste('\U{00A0}\U{00A0}',gsub(",.*$", "",baseline_up[i,1]),sep="")
}

baseline_up[43,1]<-"\U{00A0}\U{00A0}Diabetes (HBA1C>6.5%, self-report or medication use)"



saveRDS(baseline_up,paste(data_path,"/table1_24May2023.rds",sep=""))
```



```{r,echo=FALSE,tab.id="table1"}

flex_baseline<-my_table(baseline_up, y=c(1:3,10,16,22,23,38))
flex_baseline <- add_header_row(flex_baseline, values =  c("Characteristic", "Gender"),
    colwidths = c(1, 3), top = T)
flex_baseline <- compose(flex_baseline, i = 28, j = 1, part = "body",
    value = as_paragraph(
      "\U{00A0}\U{00A0}BMI (kg/m",
      as_sup("2"),")"    ) )
flex_baseline<-add_footer_lines(flex_baseline,"Abbreviation \n SBP:systolic blood pressure, DBP: diastolic blood pressure, BMI: body mass index, NMR:nuclear magnetic resonance, HDL-C: high density lipoprotein cholesterol, LDL-C: low density lipoprotein cholesterol, HbA1c: hemoglobin A1c")
flex_baseline<-footnote(flex_baseline,i=1,j=1,part="header",ref_symbols="*",value = as_paragraph("Table excludes individuals with age over 75, over one year of inconsistent age between death certificate and baseline or missing genetic data."))

#flex_baseline<-footnote(flex_baseline,i=23,j=1,part="body",ref_symbols="$",value = as_paragraph("Among participants with complete measurements, HDL_C and LDL_C have around 23% missingness."))

flex_baseline<-footnote(flex_baseline,i=42,j=1,part="body",ref_symbols="ยง",value = as_paragraph("Other diseases include self-reported emphysema, chronic kidney disease, peptic ulcer,cirrhosis, and peripheral arterial disease."))
fpp <- fp_par(text.align = "left", padding = 3)
flex_baseline<-set_caption(
 flex_baseline,
  caption = "Baseline Characteristics",align_with_table = FALSE,
 word_stylename = "Table Caption",
  fp_p = fpp
)

my_theme(flex_baseline,y=c(1:42))


```



```{r,include=FALSE}
baseline_hidemissing<-create_table_1(data=table1_data,variables_to_select = variables_to_select,var_name = var_name,by="SEX",missing = F)
baseline_up_no_missing<-rbind(baseline_hidemissing[c(2,3,12:28),],c("Biological Measures, Mean(SD)",rep(NA,3)),baseline_hidemissing[c(4:10),],c("Reoprted medical history, N(%)",rep(NA,3)),baseline_hidemissing[c(29:33),])
rownames(baseline_up_no_missing)<-seq(1:nrow(baseline_up_no_missing))
for (i in c(21:27,29:33)){
  baseline_up_no_missing[i,1]<-paste('\U{00A0}\U{00A0}',gsub(",.*$", "",baseline_up_no_missing[i,1]),sep="")
}

baseline_up_no_missing[32,1]<-"\U{00A0}\U{00A0}Diabetes (HBA1C>6.5%, self-report or medication use)"

```
```{r,include=FALSE}
flex_baseline<-my_table(baseline_up_no_missing, y=c(1:3,9,14,19,20,28))
flex_baseline <- add_header_row(flex_baseline, values =  c("Characteristic", "Gender"),
    colwidths = c(1, 3), top = T)
flex_baseline <- compose(flex_baseline, i = 23, j = 1, part = "body",
    value = as_paragraph(
      "\U{00A0}\U{00A0}BMI (kg/m",
      as_sup("2"),")"    ) )
flex_baseline<-add_footer_lines(flex_baseline,"Abbreviation \n SBP:systolic blood pressure, DBP: diastolic blood pressure, BMI: body mass index, NMR:nuclear magnetic resonance, HDL-C: high density lipoprotein cholesterol, LDL-C: low density lipoprotein cholesterol, HbA1c: hemoglobin A1c")
flex_baseline<-footnote(flex_baseline,i=1,j=1,part="header",ref_symbols="*",value = as_paragraph("Table excludes individuals with age over 75, over one year of inconsistent age between death certificate and baseline or missing genetic data."))

#flex_baseline<-footnote(flex_baseline,i=23,j=1,part="body",ref_symbols="$",value = as_paragraph("Among participants with complete measurements, HDL_C and LDL_C have around 23% missingness."))

flex_baseline<-footnote(flex_baseline,i=32,j=1,part="body",ref_symbols="ยง",value = as_paragraph("Other diseases include self-reported emphysema, chronic kidney disease, peptic ulcer,cirrhosis, and peripheral arterial disease."))



my_theme(flex_baseline,y=c(1:32))

```


##quintile table
```{r,echo=FALSE}
data_prs<-table1_data


for (i in 1:7){
  quintile<-ntile(table1_data[,34+i],5)
  quintile<-factor(quintile,levels = c(1:5),labels = c("Q1","Q2","Q3","Q4","Q5"))
  data_prs[,paste(colnames(data_prs)[34+i],"_quintile",sep="")]<-quintile
}

pgsname<-colnames(data_prs[,35:41])

pgs=pgsname[1]

variables_to_select<-c("SEX","AGE","INCOME","HDL_C","LDL_C","SBP","DBP","BASE_HBA1C","BMI","WHRATIO","EDU_LEVEL","smokegp","ACTIVITY","BASE_CHD","BASE_CVD","BASE_CANCER","diabetes_at_baseline","base_other")
var_name<-c("Sex","Age, years","Income (pesos/week)","HDL-C(nm)","LDL-C(nm)","Systolic Blood Pressure(mmHg)","Diastolic Blood Pressure(mmHg)","Baseline glycated HbA1c (%)","BMI kg/m2","Waist to Hip Ratio","Education level","Smoking status","Leisure time physical activity","Coronary Artery Disease","Cardiovascular Disease","Cancer","Diabetes (HBA1C>6.5%, self-report or take medication)","Other Diseases")
list_quintile<-NA
for (i in 1:7){
  pgs_quintile<-create_table_1(data=data_prs,variables_to_select = variables_to_select,var_name = var_name,by=paste(pgsname[i],"_quintile",sep=""),compare = T,self_define=5)
  colnames(pgs_quintile)[1]<-gsub("_standardised","",pgsname[i])
  pgs_quintile<-pgs_quintile[,c(1:6,8)]
  list_quintile[i]<-list(pgs_quintile)
}

#saveRDS(list_quintile,paste(data_path,"/PRS_quintile_tables_24May2023.rds",sep=""))
```



```{r,include=FALSE}
p<-NA
for (i in 1:7){
  flex_pgs<-my_table(list_quintile[[i]], y=c(2,3,4,6,8,10,12,14,16,19,22,28,35,41:45),x=1:7)
  flex_pgs <- add_header_row(flex_pgs, values =  c("Characteristic", "Quintiles"," "),
    colwidths = c(1, 5,1), top = T)
  flex_pgs<-add_footer_lines(flex_pgs,"Abbreviation \n SBP:systolic blood pressure, DBP: diastolic blood pressure, BMI: body mass index, NMR:nuclear magnetic resonance, HDL-C: high density lipoprotein cholesterol, LDL-C: low density lipoprotein cholesterol, HbA1c: hemoglobin A1c")
flex_pgs<-footnote(flex_pgs,i=2,j=1,part="header",ref_symbols="*",value = as_paragraph("Table excludes individuals with age over 75, over one year of inconsistent age between death certificate and baseline or missing genetic data."))
flex_pgs<-footnote(flex_pgs,i=45,j=1,part="body",ref_symbols="ยง",value = as_paragraph("Other diseases include self-reported emphysema, chronic kidney disease, peptic ulcer,cirrhosis, and peripheral arterial disease."))
flex_pgs<-footnote(flex_pgs,i=2,j=7,part="header",ref_symbols="$",value = as_paragraph("T-test for continuous traits and Chi Squared test for categorical traits.Round up to 2 decimal places."))
flex_pgs<-set_caption(
 flex_pgs,
  caption = paste(pgsname[i], "table"),align_with_table = FALSE,
 word_stylename = "Table Caption",
  fp_p = fpp
)
flex_pgs<-padding(flex_pgs,padding = 0, part = "all")
flex_pgs<-line_spacing(flex_pgs,space =0.8, part = "all")
p[i]<-list(my_theme(flex_pgs,y=c(1:44),z=1:6,fontsize = 6.8))

}



```
\newpage
<!---BLOCK_LANDSCAPE_START--->

```{r,echo=FALSE,tab.id="table2"}


p[[1]]
```

\newpage

```{r,echo=FALSE,tab.id="table3"}


p[[2]]
```


\newpage

```{r,echo=FALSE,tab.id="table4"}


p[[3]]
```

\newpage

```{r,echo=FALSE,tab.id="table5"}


p[[4]]
```

\newpage

```{r,echo=FALSE,tab.id="table6"}


p[[5]]
```

\newpage

```{r,echo=FALSE,tab.id="table7"}


p[[6]]
```

\newpage

```{r,echo=FALSE,tab.id="table8"}


p[[7]]
```
<!---BLOCK_LANDSCAPE_STOP--->

see Table \@ref(tab:table1)
see Table \@ref(tab:table2)
see Table \@ref(tab:table3)
see Table \@ref(tab:table4)
see Table \@ref(tab:table5)
see Table \@ref(tab:table6)
see Table \@ref(tab:table7)
see Table \@ref(tab:table8)
Reference example: \@ref(fig:foo)